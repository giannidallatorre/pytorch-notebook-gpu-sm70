FROM quay.io/jupyter/pytorch-notebook:cuda12-pytorch-2024-06-03

LABEL maintainer="gianni@example.com"
LABEL description="Jupyter PyTorch image with SM 7.0 (Tesla V100) support"

#USER root
#
#RUN apt-get update && \
#    apt-get install -y build-essential cmake git && \
#    apt-get clean && \
#    rm -rf /var/lib/apt/lists/*
#
# Optional: Recompile PyTorch to support older architectures
# Or install custom wheels if needed
#
#USER ${NB_UID}
#
#FROM quay.io/jupyter/pytorch-notebook:cuda12-latest

USER root

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    git cmake build-essential libjpeg-dev libpng-dev \
    python3-dev curl libopenblas-dev libomp-dev \
 && apt-get clean && rm -rf /var/lib/apt/lists/*

# Switch to non-root user
USER jovyan

# Set environment variables
ENV TORCH_CUDA_ARCH_LIST="7.0" \
    MAX_JOBS=4 \
    PYTORCH_BUILD_VERSION=2.3.0 \
    PYTORCH_BUILD_NUMBER=1

# Clone PyTorch source
RUN git clone --recursive https://github.com/pytorch/pytorch /tmp/pytorch && \
    cd /tmp/pytorch && \
    git checkout v${PYTORCH_BUILD_VERSION}

# Build and install PyTorch
RUN cd /tmp/pytorch && \
    pip install -r requirements.txt && \
    python setup.py install && \
    cd /home/jovyan && rm -rf /tmp/pytorch
